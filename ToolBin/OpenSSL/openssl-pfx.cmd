@echo off
REM Uses OpenSSL to combine a SSL Certificate (*.crt) file generated by an 
REM issuing authority with the corresponding private (*.key) file into
REM a (*.pfx) certificate file that can be imported into HTTP.SYS.
REM
REM The input files must be located in a comon folder have have the same name
REM as the domain with *.crt and *.key extensions.  The output file will have
REM same domain name with the *.pfx extension.
REM 
REM
REM Usage: openssl-pfx <folder> <domain>

if [%1]==[] goto usage
if [%2]==[] goto usage

if exist "%1\%2.key" goto haveKey

echo.
echo Input file [%1\%2.key] does not exist.
echo.
goto exit

:haveKey

if exist "%1\%2.crt" goto haveCRT

echo.
echo Input file [%1\%2.crt] does not exist.
echo.
goto exit

:haveCRT

goto execute

:usage

echo.
echo Usage: openssl-pfx ^<folder^> ^<domain^>
echo.
echo		where ^<folder^> 	- path to folder with the input files
echo              ^<domain^>  	- domain name of host (FQDN)
echo.

goto exit

:execute

echo.

openssl pkcs12 -export -out "%1\%2.pfx" -inkey "%1\%2.key" -in "%1\%2.crt"

if %ERRORLEVEL% GTR 0 goto exit

echo *** Operation completed ***
echo.
echo The KEY and CSR file have been written to: %FOLDER%
echo.

:exit